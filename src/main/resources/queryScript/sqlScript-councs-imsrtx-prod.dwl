%dw 2.0
output text/plain
--- 
"WITH
COLEDG07_F4105 AS (
 ---Based on changed since last run (review  COUMPJ and COTDAY)Hold variable COLITM
    Select TRIM(X1.COLITM) AS COLITM, TRIM(X1.COITM) AS COITM, TRIM(X1.COLEDG) AS COLEDG, TRIM(X1.COUPMJ) AS COUPMJ, TRIM(X1.COTDAY) AS COTDAY, TRIM(X1.COMCU) AS COMCU
    FROM CRPDTA.F4105 X1
    WHERE  X1.COLEDG='07' AND X1.COMCU='1801' AND (X1.COUPMJ >= $(vars.previouscifJobRun.date) AND X1.COTDAY >= $(vars.previouscifJobRun.time))
	--WHERE TRIM(X1.COLITM) IN  ('592A[M100]') 
),

IBPRP1_IBSRP4_COLITM AS (
---Query PRP1 and SRP4 where LITM = (COLITM) and IBMCU=1801.Hold the variables PRP1 and SRP4
    SELECT DISTINCT 
    TRIM(TT1.IBPRP1) AS IBPRP1, 
    TRIM(TT1.IBSRP4) AS IBSRP4, 
    TRIM(TT1.IBLITM) AS IBLITM,
    TRIM(TT1.IBITM) AS IBITM,
    TRIM(TT1.IBMCU) AS IBMCU
    FROM CRPDTA.F4102 TT1
    INNER JOIN COLEDG07_F4105 TT2 ON TRIM(TT1.IBLITM)=TRIM(TT2.COLITM) 
    and TRIM(TT1.IBMCU)='1801'
),

IMDRAW_IMSRTX_COLITM AS (
---Query IMDRAW and IMSRTX where LITM = (COLITM) and IBMCU=1801.Hold the variables IMDRAW and IMSRTX
    SELECT TRIM(TT3.IMDRAW) AS IMDRAW, TRIM(TT3.IMSRTX) AS IMSRTX, TRIM(TT3.IMLITM) AS IMLITM, TRIM(TT3.IMITM) AS IMITM
    FROM CRPDTA.F4101 TT3
    INNER JOIN COLEDG07_F4105 TT2 ON TRIM(TT3.IMITM)=TRIM(TT2.COITM)
 
),
IMLITM_ISRTX AS (
---Query IMLITM where IMSRTX = (variable) IMSRTX
    SELECT 
        TRIM(TT6.IMLITM) AS IMLITM, 
        TRIM(TT6.IMSRTX) AS IMSRTX,
        TRIM(TT6.IMDRAW) AS IMDRAW,
        TRIM(TT6.IMITM) AS IMITM
    FROM CRPDTA.F4101 TT6
    INNER JOIN IMDRAW_IMSRTX_COLITM TT7 ON TRIM(TT6.IMSRTX)= TRIM(TT7.IMSRTX)
),

COUNCS_IMSRTX AS (
---Query  COUNCS where IBLITM = COLITM and COMCU=1801 and COLEDG='07'
    SELECT TRIM(TT8.COUNCS)/10000 AS COUNCS, TRIM(TT8.COLITM) AS COLITM, TRIM(TT8.COMCU) AS COMCU, TRIM(COLEDG) AS COLEDG, TRIM(TT8.COITM) AS COITM
    FROM CRPDTA.F4105 TT8
    INNER JOIN IMLITM_ISRTX TT10 ON TRIM(TT10.IMITM)= TRIM(TT8.COITM)
)

SELECT 
T2.IMLITM,
T8.IMSRTX,
T8.IMDRAW,
MAX(T10.COUNCS) AS MAX_COUNCS_IMSRTX,
MIN(T10.COUNCS) AS MIN_COUNCS_IMSRTX


FROM CRPDTA.F4101 T2 
LEFT JOIN COLEDG07_F4105 T4 ON
     TRIM(T4.COLEDG)='07'
LEFT JOIN IBPRP1_IBSRP4_COLITM T5 ON
     TRIM(T5.IBMCU)='1801'
LEFT JOIN IMDRAW_IMSRTX_COLITM T6 ON
     T2.IMLITM=TRIM(T6.IMLITM)
LEFT JOIN IMLITM_ISRTX T8 ON
     T8.IMLITM=TRIM(T2.IMLITM)
LEFT JOIN COUNCS_IMSRTX T10 ON
     T10.COMCU='1801' 
     AND T10.COLEDG='07'


--WHERE T2.IMLITM IN  ('6203[TB00]')
--WHERE T2.IMLITM IN ('592A[M100]')
WHERE (T4.COUPMJ >= $(vars.previouscifJobRun.date) AND T4.COTDAY >= $(vars.previouscifJobRun.time)) AND TRIM(T4.COMCU)='1801'

GROUP BY
    T2.IMLITM, T8.IMDRAW, T8.IMSRTX  "