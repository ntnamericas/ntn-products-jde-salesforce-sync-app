%dw 2.0
output text/plain
--- 
"WITH

COLEDG07_F4105 AS (
 ---Based on changed since last run (review  COUMPJ and COTDAY)Hold variable COLITM
    Select TRIM(X1.COLITM) AS COLITM, TRIM(X1.COITM) AS COITM, TRIM(X1.COLEDG) AS COLEDG, TRIM(X1.COUPMJ) AS COUPMJ, TRIM(X1.COTDAY) AS COTDAY, TRIM(X1.COMCU) AS COMCU
    FROM PRODDTA.F4105 X1
    --WHERE  TRIM(X1.COLEDG)='07' AND TRIM(COMCU)='1801' AND TRIM(X1.COLITM) in ('592A[M100]') 
	--AND TRIM(X1.COLITM)='6203[TB00]'
    WHERE (X1.COUPMJ >= $(vars.previouscifJobRun.date) AND X1.COTDAY >= $(vars.previouscifJobRun.time)) AND TRIM(COMCU)='1801'
	--AND TRIM(X1.COLITM)='6002LLU/5C[TB00]' --AND TRIM(X1.COLITM)='6203[TB00]' 
	
),

IBPRP1_IBSRP4_COLITM AS (
---Query PRP1 and SRP4 where LITM = (COLITM) and IBMCU=1801.Hold the variables PRP1 and SRP4
    SELECT DISTINCT 
    TRIM(TT1.IBPRP1) AS IBPRP1, 
    TRIM(TT1.IBSRP4) AS IBSRP4, 
    TRIM(TT1.IBLITM) AS IBLITM,
    TRIM(TT1.IBITM) AS IBITM,
    TRIM(TT1.IBMCU) AS IBMCU
    FROM PRODDTA.F4102 TT1
    INNER JOIN COLEDG07_F4105 TT2 ON TRIM(TT1.IBITM)=TRIM(TT2.COITM) 
    AND TRIM(TT1.IBMCU)='1801'
),

IMDRAW_IMSRTX_COLITM AS (
---Query IMDRAW and IMSRTX where LITM = (COLITM) and IBMCU=1801.Hold the variables IMDRAW and IMSRTX
    SELECT TRIM(TT3.IMDRAW) AS IMDRAW, TRIM(TT3.IMSRTX) AS IMSRTX, TRIM(TT3.IMITM) AS IMITM, TRIM(TT3.IMLITM) AS IMLITM
    FROM PRODDTA.F4101 TT3
    INNER JOIN COLEDG07_F4105 TT2 ON TRIM(TT3.IMITM)=TRIM(TT2.COITM)
 
),

IMLITM_IMDRAW AS (
-- Query IMLITM where IMDRAW = (variable) IMDRAW and where IMPRP1 = IBPRP1 and IMSRP4 = IBSRP4
    SELECT 
        TRIM(TT6.IMDRAW) AS IMDRAW, 
        TRIM(TT6.IMLITM) AS IMLITM, 
        TRIM(TT6.IMITM) AS IMITM,
        TRIM(TT6.IMPRP1) AS IMPRP1, 
        TRIM(TT6.IMSRP4) AS IMSRP4
        FROM PRODDTA.F4101 TT6
        INNER JOIN IMDRAW_IMSRTX_COLITM TT7 ON TRIM(TT6.IMDRAW) = TRIM(TT7.IMDRAW)
        --INNER JOIN IBPRP1_IBSRP4_COLITM TT8 ON
        --TRIM(TT6.IMPRP1) = TRIM(TT8.IBPRP1) AND 
        --TRIM(TT6.IMSRP4) = TRIM(TT8.IBSRP4)
),

COUNCS_IMDRAW AS (
---Query  COUNCS where IBLITM = COLITM and COMCU=1801 and COLEDG='07'
    SELECT TRIM(TT8.COUNCS)/10000 AS COUNCS, TRIM(TT8.COLITM) AS COLITM, TRIM(TT8.COITM) AS COITM, TRIM(TT8.COMCU) AS COMCU, TRIM(COLEDG) AS COLEDG
    FROM PRODDTA.F4105 TT8
    INNER JOIN IMLITM_IMDRAW TT9 ON TRIM(TT9.IMITM)= TRIM(TT8.COITM) 
    --AND TRIM(TT8.COLEDG)='07' AND TRIM(TT8.COMCU)='1801'
)

SELECT
T2.IMLITM,
T6.IMDRAW,
T6.IMSRTX,
MAX(T9.COUNCS) AS MAX_COUNCS_IMDRAW,
MIN(T9.COUNCS) AS MIN_COUNCS_IMDRAW

FROM PRODDTA.F4101 T2     
LEFT JOIN COLEDG07_F4105 T4 ON
     TRIM(T4.COLEDG)='07'
LEFT JOIN IBPRP1_IBSRP4_COLITM T5 ON
     TRIM(T5.IBMCU)='1801'
LEFT JOIN IMDRAW_IMSRTX_COLITM T6 ON
     TRIM(T2.IMLITM)=TRIM(T6.IMLITM)
LEFT JOIN IMLITM_IMDRAW T7 ON 1=1
    -- TRIM(T7.IMPRP1) = TRIM(T2.IMPRP1) AND
    -- TRIM(T7.IMSRP4) = TRIM(T2.IMSRP4)
LEFT JOIN COUNCS_IMDRAW T9 ON
     TRIM(T9.COMCU)='1801' 
     AND TRIM(T9.COLEDG)='07'


--WHERE T2.IMLITM in ('6203[TB00]')
--WHERE T2.IMLITM = '6002LLU/5C[TB00]'
--WHERE T2.IMLITM = '592A[M100]'
WHERE (T4.COUPMJ >= $(vars.previouscifJobRun.date) AND T4.COTDAY >= $(vars.previouscifJobRun.time)) AND TRIM(T4.COMCU)='1801'
     
GROUP BY
     T2.IMLITM, T6.IMDRAW,T6.IMSRTX"